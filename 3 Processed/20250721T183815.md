
## Goal

Enable one-click **hybrid block modules** that insert both YAML and body sections into a note, without duplication or conflicts.

---

## 1 Key principles

| Fact                                                                                   | Use                                                 |
| -------------------------------------------------------------------------------------- | --------------------------------------------------- |
| Templater edits front-matter (`tp.file.set_frontmatter`, `tp.file.append_frontmatter`) | Inject or update YAML keys safely.                  |
| Templater inserts body text at cursor or marker                                        | Place mirrored section once, numbered sequentially. |
| Nested templates + palette shortcuts                                                   | Composite commands update YAML and body in sync.    |

---

## 2 Template structure

```
Templates/
├─ _core.md              ← full note scaffold
├─ blocks/               ← hybrid (YAML + body)
│   ├─ flow.md
│   ├─ taxonomy.md
│   ├─ links.md
│   └─ content.md
└─ partials/             ← body-only
    ├─ body-flow.md
    └─ body-taxonomy.md
```

* **blocks/** = hybrid YAML+body logic.
* **partials/** = pure markdown, used by hybrids.

---

## 3 Example: `blocks/flow.md`

**YAML update**

```js
<%*
const fm = tp.frontmatter;
const flow = fm["flow"] ?? {};
flow.stage   = flow.stage   ?? "capture";
flow.status  = flow.status  ?? "idea";
flow.project = flow.project ?? null;
tp.file.set_frontmatter({...fm, flow});
%>
```

**Body insert**

```js
<%*
const marker = /^##\s\d+\s[\w ]+/gm;
const body   = await tp.file.read();
const count  = [...body.matchAll(marker)].length;
const nextNo = count + 1;
const section = await tp.file.include("[[partials/body-flow.md]]");
await tp.file.insert(`\n\n## ${nextNo} Flow\n${section}`);
%>
```

Result:

```
## N Flow
| Stage | Status | Project | Sprint | Due |
|-------|--------|---------|--------|-----|
| capture | idea | -- | -- | -- |
```

Idempotent: rerun updates YAML and table, no duplicates.

---

## 4 Workflow

| Scenario     | Command                | Effect                                     |
| ------------ | ---------------------- | ------------------------------------------ |
| New note     | Core template          | Base YAML + `## 1 Core`.                   |
| Add planning | Flow template          | Adds/updates `flow` + `## 2 Flow`.         |
| Add taxonomy | Taxonomy template      | Creates `## 3 Taxonomy`.                   |
| Update stage | Rerun Flow or QuickAdd | YAML updated, body table reflects changes. |

---

## 5 Why hybrid beats separate templates

* One command guarantees parity (YAML + body).
* Automatic numbering.
* Safe YAML merges.
* Minimal shortcuts to remember.

---

## 6 Setup

1. Copy folder structure.
2. Map each block template to a palette alias or QuickAdd.
3. Set `_core.md` as default new note template.
4. Optional: composite template for promoting a note (runs taxonomy, links, content blocks sequentially).

---

## 7 Simpler variant

* Core = YAML + `## 1 Core`.
* Other blocks = body-only partials.
* Use Dataview inline fields in tables (simpler but loses strict YAML mirroring).

---

### TL;DR

Use **hybrid block templates**. Each block updates YAML and body once, renumbering automatically. Run via palette or composite templates. This keeps structure mirrored, avoids duplication, and reduces cognitive overhead.
